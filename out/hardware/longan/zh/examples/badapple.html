<!DOCTYPE html>
<html  class="md_page">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="">
    <meta name="description" content="[]">
    <meta name="generator" content="teedoc">
    <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        <link rel="stylesheet" href="/static/css/theme_default/prism.min.css" type="text/css"/>
        <link rel="stylesheet" href="/static/css/theme_default/dark.css" type="text/css"/>
        <link rel="stylesheet" href="/static/css/theme_default/light.css" type="text/css"/>
        <link rel="stylesheet" href="/static/css/custom.css" type="text/css"/>
        <script src="/static/js/theme_default/jquery.min.js"></script>
        <script src="/static/js/theme_default/pre_main.js"></script>
        <link rel="stylesheet" href="/static/css/search/style.css" type="text/css"/>
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9cb07365544a53067c56c346c838181a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    <title>Sipeed Wiki</title>
</head>
<body>
    
            <div id="navbar">
                <div id="navbar_menu">
                    <a class="site_title" href="/"><img class="site_logo" src="/static/image/logo.svg" alt="sipeed wiki logo"><h2>wiki</h2></a>
                    <a id="navbar_menu_btn"></a>
                </div>
                <div id="navbar_items">
                    <div>
                        <ul id="nav_left">
<li class=""><a  href="/">首页</a></li>
<li class=""><a target="_blank" href="https://www.sipeed.com">矽速官网</a></li>
<li class="sub_items "><a>开源软件</a><ul><li class=""><a  href="/soft/maixpy/zh/index.html">Maixpy</a></li>
<li class=""><a  href="/soft/maixpy3/zh/">Maixpy3</a></li>
<li class=""><a  href="/licheeos/zh/">Lichee OS</a></li>
<li class=""><a  href="/LonganOS/zh/">Longan OS</a></li>
<li class=""><a  href="/TangOs/zh/">Tang OS</a></li>
</ul>
</li>
<li class="sub_items active_parent"><a>开源硬件</a><ul><li class=""><a  href="/hardware/maix/zh/">Maix</a></li>
<li class=""><a  href="/hardware/maixII/zh/">Maix II</a></li>
<li class=""><a  href="/hardware/maixIII/zh/">Maix III</a></li>
<li class=""><a  href="/hardware/maixIV/zh/">Maix IV</a></li>
<li class=""><a  href="/hardware/lichee/zh/">Lichee Pi</a></li>
<li class=""><a  href="/hardware/tang/zh/">Tang</a></li>
<li class="active"><a  href="/hardware/longan/zh/">Longan</a></li>
</ul>
</li>
<li class="sub_items "><a>商业产品</a><ul><li class=""><a  href="/hardware/maixface/zh/">Maix Face</a></li>
</ul>
</li>
<li class="sub_items "><a>云平台</a><ul><li class=""><a target="_blank" href="https://www.maixhub.com">Maixhub 模型训练平台</a></li>
<li class=""><a target="_blank" href="https://www.maixhub.com/onlinecompiler">固件在线编译</a></li>
</ul>
</li>
<li class=""><a  href="/community.html">社区</a></li>
<li class=""><a  href="https://shop365481095.taobao.com/?spm=a230r.7195193.1997079397.2.8384341c2zZ5uZ">商城</a></li>
</ul>

                    </div>
                    <div>
                        <ul id="nav_right">
<li class="sub_items "><a  href="">Language: </a><ul><li class=""><a  href="/">中文</a></li>
<li class=""><a  href="/en/">English</a></li>
</ul></li>
</ul>

                        <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
                    </div>
                </div>
            </div>
    
        <div id="wrapper">
            
            <div id="sidebar_wrapper">
                <div id="sidebar">
                    <div id="sidebar_title">
                        
                    </div>
                    <ul class="show">
<li class="not_active with_link"><a href="/hardware/longan/zh/index.html"><span class="label">Sipeed Longan</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">Longan Nano</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active no_link"><a><span class="label">简介</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/hardware/longan/zh/index.html"><span class="label">关于Longan</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">准备</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/hardware/longan/zh/get_started/pio.html"><span class="label">PIO 配置</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/hardware/longan/zh/get_started/blink.html"><span class="label">Blink闪灯</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/hardware/longan/zh/get_started/debug.html"><span class="label">DEBUG 调试</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/hardware/longan/zh/get_started/sipeed-debugger.html"><span class="label">使用 Sipeed 调试器</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/hardware/longan/zh/get_started/rv-link.html"><span class="label">使用 RV-LINK</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
<li class="active_parent no_link"><a><span class="label">示例</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/hardware/longan/zh/examples/printf.html"><span class="label">串口输出</span><span class=""></span></a></li>
<li class="active with_link"><a href="/hardware/longan/zh/examples/badapple.html"><span class="label">播放 Badapple</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
</ul>

                </div>
            </div>
            <div id="menu_wrapper">
                                    <div id="menu">
                                    </div>
                                </div>
            <div id="article">
                <div id="content_wrapper">
                    <div id="content_body">
                        <div id="article_head">
                            <div id="article_title">
                                <h1></h1>
                            </div>
                            <div id="article_tags">
                                <ul></ul>
                            </div>
                            <div id="article_info">
                            <div>
                                <span class="article_author"></span><span class="article_date"></span>
                            </div>
                            <div>
                                
                            </div>
                            </div>
                        </div>
                        <div id="article_content">
                            <h1 id="bad-apple">Bad Apple 演示视频</h1>

<p>本文目的是使用板载的 160*80 分辨率的 OLED 屏幕播放 bad apple 视频</p>

<h2 id="-1">主要工作介绍</h2>

<ul>
<li>移植 OLED 屏幕的驱动</li>
<li>移植 tf 卡驱动和 fatfs 文件系统</li>
<li>将视频按自己需要的帧率转换为一帧帧的图片然后打包到 tf 卡</li>
<li>在 gd32v 上读取 tf 卡中的图片并进行显示</li>
</ul>

<h3 id="-2">屏幕驱动</h3>

<p>使用硬件 SPI 驱动屏幕，首先需要初始化 SPI</p>

<pre><code class="c language-c">void spi_config(void)
{
    spi_parameter_struct spi_init_struct;
    /* deinitilize SPI and the parameters */
    OLED_CS_Set();
    spi_struct_para_init(&amp;spi_init_struct);

    /* SPI0 parameter config */
    spi_init_struct.trans_mode           = SPI_TRANSMODE_FULLDUPLEX;
    spi_init_struct.device_mode          = SPI_MASTER;
    spi_init_struct.frame_size           = SPI_FRAMESIZE_8BIT;
    spi_init_struct.clock_polarity_phase = SPI_CK_PL_HIGH_PH_2EDGE;
    spi_init_struct.nss                  = SPI_NSS_SOFT;
    spi_init_struct.prescale             = SPI_PSC_8;
    spi_init_struct.endian               = SPI_ENDIAN_MSB;
    spi_init(SPI0, &amp;spi_init_struct);

    spi_crc_polynomial_set(SPI0,7);
    spi_enable(SPI0);
}
</code></pre>

<p>初始化完成后就可以实现数据指令的发送</p>

<pre><code class="c language-c">void LCD_Writ_Bus(u8 dat)
{
    OLED_CS_Clr();

    while(RESET == spi_i2s_flag_get(SPI0, SPI_FLAG_TBE));
        spi_i2s_data_transmit(SPI0, dat);
    while(RESET == spi_i2s_flag_get(SPI0, SPI_FLAG_RBNE));
        spi_i2s_data_receive(SPI0);

    OLED_CS_Set();
}

void LCD_WR_DATA8(u8 dat)
{
    OLED_DC_Set();//写数据
    LCD_Writ_Bus(dat);
}

void LCD_WR_DATA(u16 dat)
{
    OLED_DC_Set();//写数据
    LCD_Writ_Bus(dat&gt;&gt;8);
    LCD_Writ_Bus(dat);
}

void LCD_WR_REG(u8 dat)
{
    OLED_DC_Clr();//写命令
    LCD_Writ_Bus(dat);
}
</code></pre>

<p><code>LCD_Writ_Bus</code> 完成了 SPI 的收发，通过控制命令数据线，完成命令和数据的发送</p>

<p>OLED 屏幕在使用前还需要设置它的一些参数，比如屏幕开启、数据帧的格式等等，这些在参数在屏幕初始化的时候，通过写命令再写数据的方式写入。想修改这些参数需要依靠屏幕配套的数据手册，不过一般可以参数屏幕生产商提供的例程中的参数。</p>

<h3 id="tf-fatfs">tf 卡驱动和 fatfs 文件系统</h3>

<p>tf 卡在 longan 上也是使用 SPI 驱动的。为了更快的访问速率，也是使用硬件 SPI 驱动。使用前也需要初始化，方式和屏幕的 SPI 初始化类似，就不再累述。</p>

<p>fatfs 是一个专为小型嵌入式设备设计的文件系统。fatfs 符合 ANSI C(C89)规范，并且和磁盘 I/O 层完全分离。</p>

<p>具体的移植也很简单，直接参照 fatfs 提供的 stm32 的工程移植进行</p>

<p>这里提供该工程的<a href="http://dl.sipeed.com/LONGAN/Nano/Firmware/badapple_demo_tools/ffsample.7z">下载地址</a>，完整版可以去 fatfs 的<a href="http://elm-chan.org/fsw/ff/ffsample.zip">官网下载</a></p>

<p>主要的工作在于实现 fatfs 的几个基本函数 <code>disk_initialize</code> <code>disk_status</code> <code>disk_read</code> <code>disk_ioctl</code></p>

<p>这些函数又是基于 SPI 通信的，还需要修改 SPI 接收发送的实现</p>

<pre><code class="c language-c">static
BYTE xchg_spi (
    BYTE dat    /* Data to send */
)
{
    while(RESET == spi_i2s_flag_get(SPI1, SPI_FLAG_TBE));
        spi_i2s_data_transmit(SPI1, dat);
    while(RESET == spi_i2s_flag_get(SPI1, SPI_FLAG_RBNE));
        return(spi_i2s_data_receive(SPI1));     /* Return received byte */
}

static
void rcvr_spi_multi (
    BYTE *buff,     /* Pointer to data buffer */
    UINT btr        /* Number of bytes to receive (even number) */
)
{
    do
    {
        *buff = xchg_spi(0xff);
        buff++;
    } while (btr--);

}
</code></pre>

<h3 id="-3">视频预解码</h3>

<p>mp4 格式的视频，单片机因为没有硬件的加速，无法胜任解码播放的工作，所以只能靠手工预解码，相当于按照一定的帧率对原视频进行截图</p>

<p>这里需要使用到 PotPlayer XnViewMP</p>

<p>首先使用 PotPlayer 打开视频，快捷键 ctrl+G 打开连续截图</p>

<p>打开后如图</p>

<p><img src="../../assets/examples/potplayer.png" alt="" /></p>

<p>其中格式一定要 BMP，尺寸按照屏幕的尺寸设置，时间我这里设置的是 100ms 也就是 1s 十帧的样子，采集数量就自己计算一下视频总时间再乘每秒帧数，我这里就是 219s * 10 = 2190</p>

<p>最后得到的图片是 32位 的 BMP，转换起来不方便，就用 XnViewMP 转换为 24位 的 BMP</p>

<p>打开 XnViewMP ，选择要转换的图片，快捷键 ctrl+U 打开批量转换，在动作中选择 24位 进行转换，如图</p>

<p><img src="../../assets/examples/XnViewMP.png" alt="" /></p>

<p>然后就是将这些图片打包到 tf 卡，这里为了方便，修改了网上的一个开源项目 <a href="https://github.com/robertgallup/bmp2hex">bmp2hex</a>，重新整理了一个工具，可以<a href="http://dl.sipeed.com/LONGAN/Nano/Firmware/badapple_demo_tools/tools_bmp2hex.zip">点击下载</a></p>

<p>使用方法很简单，把下载的这个压缩包放到之前生成的图片集中，进行解压</p>

<p>使用工具前需要确保所有图片的名字是 数字.bmp ，不是的话可以先运行一遍 rename.py 这个脚本，直接在命令行输入 <code>python rename.py</code> 即可</p>

<p>根据自己图片总数修改 genhex.py 这个脚本的第4行中的数字，比如我有 2190张 图片，这里的数字就写 2190</p>

<p>然后就运行这个脚本，在命令行输入 <code>python genhex.py</code>，时间可能比较久，需要耐心等待</p>

<p>最后运行完毕后会生成一个 bmp.bin 文件，将这个文件放入到 tf 卡中即可</p>

<h3 id="-4">读取图片</h3>

<p>最后的读取图片并显示其实很简单了，主要涉及到的就是文件操作，关于 fatfs 的 API <a href="http://elm-chan.org/fsw/ff/doc/open.html">可以点击这里阅读</a></p>

<p>首先需要将 tf 卡挂载到文件系统，这里需要使用到 f_mount 这个函数</p>

<pre><code class="c language-c">fr = f_mount(&amp;fs, "", 1);
</code></pre>

<p>挂载上后，就找到对应的文件然后打开，这里涉及到 f_open</p>

<pre><code class="c language-c">fr = f_open(&amp;fil, "bmp.bin", FA_READ);
</code></pre>

<p>文件打开后，就可以读取图片信息并显示了，这里 160*80 尺寸的 16位真彩图片，一张有 25600 字节，longan 上的处理器无法直接创建一个这么大的数组，所以只能分两次进行读取，每次读取完进行一次偏移，最后通过循环读取总共的 2189 张图片，这里涉及到 f_read f_lseek</p>

<pre><code class="c language-c">for (int i=0; i&lt;2189;i++)
{
        fr = f_read(&amp;fil, image, sizeof(image), &amp;br);
        LCD_ShowPicture(0,0,159,39);
        offset += 12800;
        f_lseek(&amp;fil, offset);
        LEDB_TOG;
        fr = f_read(&amp;fil, image, sizeof(image), &amp;br);
        LCD_ShowPicture(0,40,159,79);
        offset += 12800;
        f_lseek(&amp;fil, offset);
        LEDB_TOG;
}
</code></pre>

<p>最后，本工程可以到 github 下载体验，<a href="https://github.com/sipeed/Longan_GD32VF_examples">点击进行传送</a></p>

                        </div>
                    </div>
                    <div id="previous_next">
                        <div id="previous">
                            <a href="/hardware/longan/zh/examples/printf.html"><span class="icon"></span><span class="label">串口输出</span></a>
                        </div>
                        <div id="next">
                            
                        </div>
                    </div>
                </div>
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
        <a id="to_top" href="#"></a>
        <div id="doc_footer">
                        
            <div id="footer">
                <div id="footer_top">
                    <ul>
<li><a>链接</a><ul><li><a target="_blank" href="https://www.sipeed.com">Sipeed</a></li>
<li><a target="_blank" href="https://bbs.sipeed.com/">BBS 论坛</a></li>
<li><a target="_blank" href="https://maixhub.sipeed.com/">Maixhub</a></li>
<li><a target="_blank" href="https://sipeed.taobao.com/">Sipeed 淘宝</a></li>
<li><a target="_blank" href="https://github.com/neutree/teedoc">使用 teedoc 构建</a></li>
</ul>
</li>
<li><a>网站统计</a><ul><li><a target="_blank" href="https://tongji.baidu.com/web/welcome/ico?s=9cb07365544a53067c56c346c838181a">百度统计</a></li>
<li><a  href="/sitemap.xml">网站地图</a></li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/sipeed/sipeed_wiki">文档源文件</a></li>
<li><a target="_blank" href="https://github.com/sipeed">开源项目源码</a></li>
</ul>
</li>
<li><a>关注我们</a><ul><li><a target="_blank" href="https://github.com/sipeed">github</a></li>
<li><a target="_blank" href="https://twitter.com/SipeedIO">twitter</a></li>
<li><a target="_blank" href="https://sipeed.taobao.com/">淘宝</a></li>
<li><a  href="/social_group.html">更多</a></li>
</ul>
</li>
<li><a>联系我们</a><ul><li><a>电话: +86 0755-27808509</a>
</li>
<li><a>商业支持: support@sipeed.com</a>
</li>
<li><a>地址: 深圳市宝安区新湖路华美居B区1号楼713-715</a>
</li>
<li><a  href="/join_us.html">加入我们</a></li>
</ul>
</li>
</ul>

                </div>
                <div id="footer_bottom">
                    <ul>
<li><a target="_blank" href="https://www.sipeed.com">©2018-2021 深圳矽速科技有限公司</a></li>
<li><a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index">粤ICP备19015433号-1</a></li>
</ul>

                </div>
            </div>
                    </div>
</body>
<script src="/static/js/theme_default/tocbot.min.js"></script>
<script src="/static/js/theme_default/main.js"></script>
<script src="/static/css/theme_default/prism.min.js"></script>
<script src="/static/js/custom.js"></script>
<script src="/static/js/search/search_main.js"></script>
<script type="text/javascript" src="/static/js/live.js"></script>
</html>
